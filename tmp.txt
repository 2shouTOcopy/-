#!/bin/sh

# 引入日志库（提供 LOG_DIR/LOG_NAME/LOG_COUNT 默认值、log_msg、rotate_logs）
. /mnt/app/loglib.sh

# =============================================================
mkdir /var/lock
cp /mnt/app/fw_env.config /etc/

/mnt/app/fw_setenv bootlog 2
boot_log=`/mnt/app/fw_printenv bootlog`

# default no redirect, may be change the serial output
if [ -z "$boot_log" ]; then
	/mnt/app/fw_setenv bootlog 0
    boot_log="bootlog=0"
fi

env_param="`/mnt/app/fw_printenv bootlog`;"

if [ "$boot_log" = "bootlog=0" ]; then
    : 
elif [ "$boot_log" = "bootlog=1" ]; then
	echo 1 > /sys/class/gpio/gpio161/value #open serial tx
	echo "serial boot, open tx !!!!!!!!!!!!!!!!!"	
elif [ "$boot_log" = "bootlog=2" ]; then
	# /mnt/app/fw_setenv bootlog 2
	/mnt/app/fw_setenv apploglevel 4
	boot_log="bootlog=2"

	exec 3>&1
	exec 4>&2
    
    # 先轮转，再重定向
    rotate_logs "$LOG_NAME" "$LOG_COUNT"
	exec > "${LOG_DIR}/${LOG_NAME}" 2>&1

	log_msg "Stdout and Stderr are now redirected to ${LOG_DIR}/${LOG_NAME}"
	set -x
	env_param=$env_param"log_path=${LOG_DIR}/${LOG_NAME};"
fi

log_msg "Welcome to SmartCamera"

# init tx ctrl
echo 161 > /sys/class/gpio/export
echo out > /sys/class/gpio/gpio161/direction
echo 1 > /sys/class/gpio/gpio161/value

loglevel=`/mnt/app/fw_printenv apploglevel`

# keep slient by default 
if [ -z "$loglevel" ]; then
	/mnt/app/fw_setenv apploglevel 8
fi

env_param=$env_param"`/mnt/app/fw_printenv apploglevel`;"

loglevel=`/mnt/app/fw_printenv dsploglevel`

if [ -z "$loglevel" ]; then
	/mnt/app/fw_setenv dsploglevel 8
fi

env_param=$env_param"`/mnt/app/fw_printenv dsploglevel`;"

loglevel=`/mnt/app/fw_printenv algologlevel`

if [ -z "$loglevel" ]; then
	/mnt/app/fw_setenv algologlevel 8
fi

env_param=$env_param"`/mnt/app/fw_printenv algologlevel`;"

echo $env_param > /mnt/cfg/app_param.txt

log_msg "APP Start ..."

if [ "$boot_log" = "bootlog=2" ]; then
	exec 1>&3 3>&-   # restore stdout and close file descriptor #3
	exec 2>&4 4>&-   # restore stdout and close file descriptor #4
	set +x
fi

cd /home/
[ -e /mnt/cfg/disablewd ] || ./watchdog &
if [ -e /mnt/cfg/disableuart ]; then
    ./m320_app &
else
    ./m320_app
fi