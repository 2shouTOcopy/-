好的 ✅
下面是精简版的《SC_GVMP 连接流程与细节（现行实现版）》，
去掉所有 TLS/双向认证内容，仅保留当前真实行为与关键实现细节，可直接纳入设计文档或接口规范。

⸻

SC_GVMP 连接流程与细节（现行实现）

1. 概述

SC_GVMP（Smart Camera GigE Video Message Protocol） 是相机与客户端（SC SDK / SCMVS）之间的图像传输通道协议。
该协议采用 TCP 传输，在用户点击“开启取流”后由 SDK 控制相机通过寄存器配置主机地址与端口，再由相机主动建立 TCP 链路并推送图像数据。

⸻

2. 整体时序

@startuml
title SC_GVMP 取流连接时序（当前实现）

actor User
participant "SC SDK\n(SCMVS)" as SDK
participant "设备" as DEV
participant "主机(PC)" as HOST

== 开启取流 ==
User -> SDK : 点击“开启取流”
SDK -> DEV : WriteReg(MCDA) = 主机IP
SDK -> DEV : WriteReg(MCP) = 主机端口
DEV -> HOST : TCP SYN
HOST -> DEV : SYN-ACK
DEV -> HOST : ACK  (三次握手完成)

SDK -> DEV : WriteReg(STREAM_START) = 1
DEV -> HOST : 发送图像数据（TCP）
@enduml


⸻

3. 流程步骤说明

（1）MCDA 设置目标地址
	•	寄存器名：MCDA（Message Channel Destination Address）
	•	长度：4 字节
	•	内容：主机 IPv4 地址（网络序），SDK 在下发时需确保与实际 PC 网卡一致。
	•	生效时机：写入即缓存，不立即触发连接。

（2）MCP 设置主机端口
	•	寄存器名：MCP（Message Channel Port）
	•	长度：2 字节
	•	内容：主机接收端口号（0–65535）。
	•	生效时机：写入即缓存，不立即触发连接。

（3）设备主动建立 TCP 连接
	•	设备在收到完整的 MCDA 与 MCP 配置后，等待 STREAM_START=1 信号。
	•	当 STREAM_START=1：
	•	设备作为 TCP 客户端，向 MCDA:MCP 发起连接；
	•	建立连接使用标准三次握手；
	•	连接成功后进入“Streaming”状态。

（4）启动取流
	•	寄存器名：STREAM_START
	•	写入值：
	•	1 → 启动取流流程（设备建立 TCP 并发送图像）
	•	0 → 停止取流（关闭 TCP 连接，释放资源）
	•	当 STREAM_START=1 时设备开始从采集通道取图并封包发送。
	•	当 STREAM_START=0 时立即停止取流并断开连接。

（5）图像传输
	•	传输通道：建立好的 TCP 长连接。
	•	数据封装：
	•	每帧以固定头部结构发送，典型格式如下（实际按型号定义）：

+-----------+--------+-----------+-----------+
| Magic(2B) | Ver(1) | Flags(1)  | Seq(4B)   |
+-----------+--------+-----------+-----------+
| PayloadLen(4B) | 图像数据内容 |
+------------------------------------------+


	•	Magic：帧同步标识
	•	Seq：帧序号递增
	•	PayloadLen：图像数据长度

	•	图像内容可为编码帧（JPEG/H264/H265）或原始帧（RAW/YUV），依产品配置。

⸻

4. 设备端状态机（当前）

@startuml
title SC_GVMP 设备状态机（现行）

[*] --> Idle
Idle --> Connecting : STREAM_START=1 且 MCDA/MCP 有效
Connecting --> Streaming : TCP 建链成功
Connecting --> Error : 超时/失败
Streaming --> Idle : STREAM_START=0
Streaming --> Error : TCP异常断开
Error --> Idle : STREAM_START=0
@enduml


⸻

5. 寄存器交互规则

寄存器名	功能描述	长度	写入方向	备注
MCDA	目标主机 IP 地址	4B	SDK→设备	写入缓存
MCP	目标主机端口号	2B	SDK→设备	写入缓存
STREAM_START	启停控制位	1B	SDK→设备	1=开始取流；0=停止
STREAM_STATE	当前状态	1B	设备→SDK	0=Idle,1=Connecting,2=Streaming,3=Error
ERR_CODE	最近错误码	2B	设备→SDK	用于诊断

写入顺序建议：
	1.	MCDA
	2.	MCP
	3.	STREAM_START=1

若 STREAM_START=1 在前两者未写入时执行，应返回错误 ERR_PARAM_INCOMPLETE。

⸻

6. 错误码定义（建议）

错误码	含义
ERR_PARAM_INCOMPLETE	MCDA/MCP 未配置
ERR_CONNECT_FAIL	TCP 建链失败（主机不可达）
ERR_CONNECT_TIMEOUT	TCP 超时
ERR_STREAM_BUSY	当前已有取流会话
ERR_TCP_RESET	连接被对端关闭
ERR_NO_SESSION	未登录或会话过期（在安全红线鉴权机制启用时）


⸻

7. 异常与重连逻辑
	•	连接失败或断开：
	•	设置 STREAM_STATE=Error；
	•	记录 ERR_CODE；
	•	若 STREAM_START=1 保持不变，可周期性重试（退避重连策略，典型为 1s→2s→4s）。
	•	主动停止：
	•	SDK 写 STREAM_START=0；
	•	设备立即关闭 TCP 并回到 Idle 状态。
	•	心跳/空闲保持：
	•	当前实现不包含 TCP 保活包，可选开启 SO_KEEPALIVE（默认关闭）。

⸻

8. SDK 侧建议逻辑
	1.	开启取流

WriteReg(MCDA)
WriteReg(MCP)
WriteReg(STREAM_START=1)

等待状态回调或 STREAM_STATE=Streaming 后开始接收图像。

	2.	停止取流

WriteReg(STREAM_START=0)

等待状态回到 Idle。

	3.	断线重连
当检测到 STREAM_STATE=Error 时，SDK 可自动写 STREAM_START=1 重启。

⸻

9. 当前版本特性小结

特性项	说明
传输协议	TCP
建链方向	设备 → 主机
控制方式	SDK 通过寄存器配置 MCDA/MCP/STREAM_START
取流触发	STREAM_START=1
停止取流	STREAM_START=0
会话要求	需在已登录状态（激活后、cookie 有效期内）
重连策略	设备端可自动或 SDK 侧主动重启
安全特性	当前为明文 TCP；后续计划扩展双向认证


⸻

这样版本只描述当前实际的取流逻辑和控制流程，
未来若增加双向认证（TLS/mTLS），只需在该节末尾追加一个“扩展说明”即可，无需重写主流程。