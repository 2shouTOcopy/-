# /data1/zhoufeng20/work/tmp/grpc_install/src/grpc-1.73.0/third_party/utf8_range/CMakeLists.txt

if (NOT TARGET utf8_range) # This original check means utf8_range might be defined elsewhere
  # --- DELETE THIS LINE (If you added it previously for issue #1) ---
  # add_library(utf8_range STATIC utf8_range.c)
  # -------------------------------------------------------------------

  set(utf8_range_ENABLE_TESTS OFF CACHE BOOL "Disable utf8_range tests" FORCE) # <--- ADD FORCE to ensure it's OFF
  # Set up Abseil dependency for utf8_range (fixes error #3 for Abseil)
  # ABSL_ROOT_DIR needs to be defined relative to this CMakeLists.txt
  set(ABSL_ROOT_DIR "${CMAKE_CURRENT_SOURCE_DIR}/../abseil-cpp") # Relative path to gRPC's Abseil submodule
  set(ABSL_ENABLE_INSTALL ${utf8_range_ENABLE_INSTALL}) # This variable might be passed down, or set here
  set(ABSL_PROPAGATE_CXX_STD ON)

  # Check if Abseil's CMakeLists.txt exists at the calculated path
  if (NOT EXISTS "${ABSL_ROOT_DIR}/CMakeLists.txt")
    message(FATAL_ERROR "Abseil source for utf8_range not found at ${ABSL_ROOT_DIR}")
  endif()
  
  # Ensure Abseil is added as a subdirectory, no find_package
  add_subdirectory(${ABSL_ROOT_DIR} third_party/abseil-cpp)
  message(STATUS "utf8_range: Manually added Abseil as subdirectory.")
endif() # End of if (NOT TARGET utf8_range) block


## (Keep the rest of the original file, it defines utf8_validity and sets its properties)
# A heavier-weight C++ wrapper that supports Abseil.
add_library (utf8_validity utf8_range.c) # This line is from original file

set_target_properties(utf8_range PROPERTIES # This target should be defined outside this file.
  VERSION ${protobuf_VERSION}
  OUTPUT_NAME ${LIB_PREFIX}utf8_range
)
set_target_properties(utf8_validity PROPERTIES
  VERSION ${protobuf_VERSION}
  OUTPUT_NAME ${LIB_PREFIX}utf8_validity
)

# --- Remove or comment out the original Abseil Load logic (as we added it above) ---
# if (NOT TARGET absl::strings)
#   if (NOT ABSL_ROOT_DIR)
#     find_package(absl REQUIRED CONFIG)
#   else ()
#     set(ABSL_ENABLE_INSTALL ${utf8_range_ENABLE_INSTALL})
#     set(ABSL_PROPAGATE_CXX_STD ON)
#     add_subdirectory(${ABSL_ROOT_DIR} third_party/abseil-cpp)
#   endif ()
# endif ()
# ----------------------------------------------------------------------------------

target_link_libraries(utf8_validity PUBLIC absl::strings)

# --- ADD THIS BLOCK TO DISABLE GTEST ---
# Original line 54: find_package(GTest REQUIRED)
# Disable GTest if tests are explicitly off.
# This assumes that `utf8_range_ENABLE_TESTS` is correctly set to OFF earlier.
if (utf8_range_ENABLE_TESTS) # Only include gtest if tests are enabled
  # Keep original GTest logic here if you want tests
  find_package(GTest REQUIRED) # This line should now be protected
  target_link_libraries(utf8_validity PRIVATE GTest::gtest_main)
else()
  message(STATUS "Skipping GTest setup in utf8_range as utf8_range_ENABLE_TESTS is OFF.")
endif()
# ------------------------------------

# (Remaining part of the original file)
